<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expressing Opinions (Personal Constructions)</title>
    
    <style>
        :root {
            --primary-blue: #007bff;
            --dark-blue: #0056b3;
            --green: #28a745;
            --red: #dc3545;
            --yellow: #f0ad4e;
            --bg-color: #f0f4f8;
            --container-bg: #ffffff;
            --text-color: #333;
            --header-bg: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            --tab-bg: #f1f1f1;
            --tab-active-bg: var(--primary-blue);
            --tab-text: #555;
            --tab-active-text: #ffffff;
            --border-color: #dee2e6;
            --light-gray-bg: #f8f9fa;
        }
        body.dark-mode { --bg-color: #121212; --container-bg: #1e1e1e; --text-color: #e0e0e0; --header-bg: #1e1e1e; --tab-bg: #333; --tab-active-bg: var(--primary-blue); --tab-text: #bbb; --tab-active-text: #ffffff; --border-color: #444; --light-gray-bg: #2a2a20; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: background-color 0.3s; }
        .container { max-width: 950px; margin: 0 auto; background-color: var(--container-bg); border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.07); overflow: hidden; }
        header { background: var(--header-bg); color: white; padding: 20px 35px; text-align: center; position: relative; }
        .header-controls { position: absolute; top: 15px; right: 15px; display: flex; gap: 10px; }
        .control-button { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.7); color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .main-tab-nav { display: flex; background-color: var(--tab-bg); border-bottom: 3px solid var(--dark-blue); }
        .main-tab-nav button { background-color: inherit; border: none; padding: 18px 25px; cursor: pointer; font-size: 1.1em; font-weight: bold; color: var(--tab-text); flex-grow: 1; }
        .main-tab-nav button.active { background-color: var(--tab-active-bg); color: var(--tab-active-text); }
        .main-tab-content { display: none; padding: 30px; }
        .main-tab-content.is-active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Estilos Espec√≠ficos */
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tense-box { background-color: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; }
        .icon-wrapper { font-size: 4.5em; margin-bottom: 15px; display:block; text-align:center; }
        .formula-visualizer { background-color: var(--light-gray-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px; }
        .formula-part { padding: 8px 12px; border-radius: 5px; background-color: var(--container-bg); border: 1px solid var(--border-color); margin: 0 5px; display: inline-block; font-weight: bold; }
        .formula-part.subjunctive { background-color: #fff0f0; color: var(--red); border-color: var(--red); }
        .formula-part.infinitive { background-color: #f0fff0; color: var(--green); border-color: var(--green); }
        
        /* Video */
        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; background: #000; margin-top: 20px; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* Pr√°ctica */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .refresh-btn { font-size: 0.9em; padding: 5px 10px; background-color: var(--primary-blue); color: white; border:none; border-radius: 4px; cursor: pointer; }
        .quiz-question { margin-bottom: 20px; background: var(--light-gray-bg); padding: 15px; border-radius: 5px; }
        .quiz-question button { background-color: var(--container-bg); border: 1px solid var(--primary-blue); color: var(--primary-blue); padding: 8px 15px; margin-right: 10px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
        .quiz-question button:hover { background-color: var(--primary-blue); color: white; }
        .feedback { font-weight: bold; margin-left: 10px; }
        .correct { color: var(--green); } .incorrect { color: var(--red); }
        .explanation-text { font-size: 0.9em; color: #555; margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; }

        .interactive-story { background: #fdfaf6; border: 1px solid var(--yellow); padding: 20px; border-radius: 8px; line-height: 2; font-size: 1.1em; }
        .interactive-story select { font-size: 1em; padding: 2px 5px; }
        
        .sorter-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .dropzone { min-height: 200px; background: var(--light-gray-bg); border: 3px dashed var(--border-color); border-radius: 8px; padding: 10px; }
        .draggable { background-color: var(--container-bg); border: 1px solid #ccc; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: grab; }
        #items-to-sort { margin-top: 20px; padding: 10px; background: var(--tab-bg); border-radius: 8px; min-height: 60px; }

        /* Flashcards */
        .flashcard-container { width: 90%; max-width: 500px; height: 300px; perspective: 1000px; margin: 0 auto 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 10px; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; font-size: 1.5em; border-radius: 10px; background: var(--container-bg); border: 2px solid var(--primary-blue); }
        .card-back { background: var(--light-gray-bg); border-color: var(--green); transform: rotateY(180deg); }
        .flashcard-nav { display: flex; justify-content: center; gap: 20px; }

        .tts-icon { font-size: 1.1em; cursor: pointer; margin-left: 8px; }
        
        /* REPORT FOOTER */
        footer { background: #333; color: white; padding: 20px; text-align: center; margin-top: 0; }
        .report-box { background: #444; padding: 15px; border-radius: 8px; display: inline-block; margin-top: 10px; max-width: 80%; word-break: break-all; }
        .btn-finish { background: var(--green); color: white; border: none; padding: 10px 20px; font-size: 1.1em; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="header-controls">
            <button class="control-button" onclick="toggleTheme()">‚òÄÔ∏è/üåô</button>
        </div>
        <h1>Expressing Opinions</h1>
        <p>Personal Constructions (Parece bien/mal...)</p>
    </header>
    
    <nav class="main-tab-nav">
        <button class="main-tab-link active" onclick="changeMainTab(event, 'tab-metaphor')">üë§=üë§ vs. üë§‚â†üë• The Rule</button>
        <button class="main-tab-link" onclick="changeMainTab(event, 'tab-practice')">üß† Interactive Practice</button>
        <button class="main-tab-link" onclick="changeMainTab(event, 'tab-flashcards')">üìá Flashcards</button>
    </nav>

    <main>
        <div id="tab-metaphor" class="main-tab-content is-active">
            <div class="comparison-grid">
                <div class="tense-box">
                    <div class="icon-wrapper" style="color: var(--green);"><span>üë§=üë§</span></div>
                    <h3 style="color: var(--green);">Infinitive (Same Subject)</h3>
                    <p>"Me parece bien <strong>hablar</strong>."</p>
                </div>
                <div class="tense-box">
                    <div class="icon-wrapper" style="color: var(--red);"><span>üë§‚â†üë•</span></div>
                    <h3 style="color: var(--red);">Subjunctive (Diff Subject)</h3>
                    <p>"Me parece bien que <strong>hables</strong>."</p>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">Video Tutorial</h3>
            <div class="video-container">
                <iframe src="https://drive.google.com/file/d/1Ez-tCYUf3rnTImlgoRKYdsewhWE9iOzN/preview" allow="autoplay"></iframe>
            </div>

            <h3 style="margin-top: 30px;">Interactive Formula</h3>
            <div class="formula-visualizer">
                <label class="switch">
                    <input type="checkbox" id="que-toggle" onchange="toggleFormula()"> Switch
                </label>
                <div class="formula-display" style="margin-top:10px; font-size:1.3em;">
                    <span class="formula-part">A m√≠ me parece bien...</span>
                    <span class="formula-part" id="formula-que" style="display: none;">que</span>
                    <span class="formula-part infinitive" id="formula-result"><strong>participar</strong>.</span>
                </div>
            </div>
        </div>

        <div id="tab-practice" class="main-tab-content">
            <div class="quiz-section">
                <div class="section-header">
                    <h3>Part 1: Quick Quiz</h3>
                    <button id="generate-quiz" class="refresh-btn">New Quiz</button>
                </div>
                <div id="quiz-container"></div>
            </div>

            <div class="quiz-section">
                <div class="section-header">
                    <h3>Part 2: Story</h3>
                    <button id="generate-story" class="refresh-btn">New Story</button>
                </div>
                <div id="story-container" class="interactive-story"></div>
                <button onclick="checkStory()" class="button-primary" style="margin-top:15px;">Check Story</button>
            </div>

            <div class="quiz-section">
                <div class="section-header">
                    <h3>Part 3: Sorter</h3>
                    <button id="generate-drag" class="refresh-btn">New Sorter</button>
                </div>
                <div id="items-to-sort"></div>
                <div class="sorter-container">
                    <div class="dropzone" id="zone-infinitive"><h4>Infinitive (Same Subject)</h4></div>
                    <div class="dropzone" id="zone-subjunctive"><h4>Subjunctive (Diff Subject)</h4></div>
                </div>
                <button onclick="checkDrag()" class="button-primary" style="margin-top:15px;">Check Sorter</button>
                <div id="drag-feedback" class="feedback"></div>
            </div>
        </div>

        <div id="tab-flashcards" class="main-tab-content">
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard">
                    <div class="card-face card-front" id="fc-front"></div>
                    <div class="card-face card-back" id="fc-back"></div>
                </div>
            </div>
            <div class="flashcard-nav">
                <button class="control-button" onclick="prevCard()">Prev</button>
                <button class="control-button" onclick="flipCard()">Flip</button>
                <button class="control-button" onclick="nextCard()">Next</button>
            </div>
        </div>
    </main>

    <footer>
        <h3 style="color:white; border:none;">Finalizar Pr√°ctica</h3>
        <p>Cuando termines, haz clic aqu√≠ para generar tu c√≥digo de validaci√≥n.</p>
        <button class="btn-finish" onclick="generateReportCode()">üèÅ Terminar y Generar C√≥digo</button>
        
        <div id="report-display" style="display:none; margin-top:20px;">
            <p>Copia este c√≥digo y p√©galo en Blackboard:</p>
            <div class="report-box" id="report-code" style="font-family:monospace; color:#ffc107;"></div>
        </div>
    </footer>
</div>

<script>
// --- TRACKING SYSTEM ---
let sessionLog = {
    start: new Date().toISOString(),
    quizCorrect: 0,
    quizTotal: 0,
    storyAttempts: 0,
    dragCorrect: 0,
    errors: []
};

function logError(section, detail) {
    sessionLog.errors.push(`[${section}] ${detail}`);
}

// --- DATA ---
const quizBank = [
    { q: "Me parece bien (ir) al cine.", a: ["ir", "vaya"], c: 0, e: "Same subject -> Infinitive" },
    { q: "Me parece bien que t√∫ (ir).", a: ["ir", "vayas"], c: 1, e: "Diff subject -> Subjunctive" },
    { q: "Nos molesta (esperar).", a: ["esperar", "esperemos"], c: 0, e: "Same subject -> Infinitive" },
    { q: "Nos molesta que ellos (esperar).", a: ["esperar", "esperen"], c: 1, e: "Diff subject -> Subjunctive" },
    { q: "Le importa (estudiar).", a: ["estudiar", "estudie"], c: 0, e: "Same subject -> Infinitive" },
    { q: "Le importa que yo (estudiar).", a: ["estudiar", "estudie"], c: 1, e: "Diff subject -> Subjunctive" },
    { q: "Te sorprende (ver) esto.", a: ["ver", "veas"], c: 0, e: "Same subject -> Infinitive" },
    { q: "Te sorprende que yo (ver).", a: ["ver", "vea"], c: 1, e: "Diff subject -> Subjunctive" }
];
const storyBank = [
    { html: `<span>A m√≠ me hace ilusi√≥n</span> <select data-a="c"><option value="c">aprender</option><option value="w">aprenda</option></select> <span>quechua. Pero a mis padres les parece mal que yo</span> <select data-a="s"><option value="s">estudie</option><option value="i">estudiar</option></select> <span>una lengua ind√≠gena.` }
];
const dragBank = [
    { t: "Me parece bien <strong>comer</strong>.", cat: "infinitive" },
    { t: "Me parece bien que <strong>comas</strong>.", cat: "subjunctive" },
    { t: "Nos molesta <strong>esperar</strong>.", cat: "infinitive" },
    { t: "Nos molesta que <strong>esperen</strong>.", cat: "subjunctive" }
];
const flashcards = [
    { f: "It seems good to me to help.", b: "Me parece bien <strong>ayudar</strong>." },
    { f: "It seems good to me that you help.", b: "Me parece bien que <strong>ayudes</strong>." }
];

// --- LOGIC ---
document.addEventListener('DOMContentLoaded', () => {
    window.changeMainTab = (e, id) => {
        document.querySelectorAll('.main-tab-content').forEach(el => el.classList.remove('is-active'));
        document.querySelectorAll('.main-tab-link').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('is-active');
        e.currentTarget.classList.add('active');
    };

    // Visualizer
    window.toggleFormula = () => {
        const chk = document.getElementById('que-toggle').checked;
        document.getElementById('formula-que').style.display = chk ? 'inline-block' : 'none';
        const res = document.getElementById('formula-result');
        res.innerHTML = chk ? '<strong>participes</strong>.' : '<strong>participar</strong>.';
        res.className = chk ? 'formula-part subjunctive' : 'formula-part infinitive';
    };

    // Quiz
    window.generateQuiz = () => {
        const c = document.getElementById('quiz-container');
        c.innerHTML = '';
        quizBank.sort(()=>0.5-Math.random()).slice(0,4).forEach((q,i) => {
            c.innerHTML += `<div class="quiz-question"><p>${i+1}. ${q.q} <span class="tts-icon" onclick="speak('${q.q}')">üîä</span></p>
            <button onclick="checkQ(this, ${q.c===0}, '${q.q}')">${q.a[0]}</button>
            <button onclick="checkQ(this, ${q.c===1}, '${q.q}')">${q.a[1]}</button>
            <div class="explanation-text" style="display:none">${q.e}</div></div>`;
        });
    };
    window.checkQ = (btn, isC, txt) => {
        const p = btn.parentElement;
        p.querySelector('.explanation-text').style.display = 'block';
        if(isC) { 
            btn.style.background = "var(--green)"; sessionLog.quizCorrect++; 
        } else { 
            btn.style.background = "var(--red)"; logError("Quiz", txt); 
        }
        sessionLog.quizTotal++;
    };

    // Story
    window.generateStory = () => {
        document.getElementById('story-container').innerHTML = storyBank[0].html;
    };
    window.checkStory = () => {
        sessionLog.storyAttempts++;
        document.querySelectorAll('select').forEach(s => {
            if((s.value === 'c' && s.dataset.a === 'c') || (s.value === 's' && s.dataset.a === 's')) s.style.border = "2px solid green";
            else { s.style.border = "2px solid red"; logError("Story", "Selection error"); }
        });
    };

    // Drag
    window.generateDrag = () => {
        const p = document.getElementById('items-to-sort');
        p.innerHTML = '';
        dragBank.forEach(i => {
            const d = document.createElement('div');
            d.className = 'draggable'; d.draggable = true;
            d.innerHTML = i.t; d.dataset.cat = i.cat;
            d.addEventListener('dragstart', e => { e.dataTransfer.setData('c', i.cat); e.target.classList.add('dragging'); });
            d.addEventListener('touchstart', touchStart, {passive:false});
            p.appendChild(d);
        });
    };
    
    // Touch Logic (iPad)
    let tDrag = null;
    function touchStart(e) { tDrag = e.target; e.preventDefault(); }
    document.addEventListener('touchmove', e => { if(tDrag) { tDrag.style.position='fixed'; tDrag.style.left=e.touches[0].clientX+'px'; tDrag.style.top=e.touches[0].clientY+'px'; } }, {passive:false});
    document.addEventListener('touchend', e => {
        if(!tDrag) return;
        const drop = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY).closest('.dropzone');
        if(drop && drop.id.includes(tDrag.dataset.cat)) { drop.appendChild(tDrag); tDrag.style.position=''; sessionLog.dragCorrect++; }
        tDrag = null;
    });

    document.querySelectorAll('.dropzone').forEach(z => {
        z.addEventListener('dragover', e => e.preventDefault());
        z.addEventListener('drop', e => {
            e.preventDefault();
            const cat = e.dataTransfer.getData('c');
            const d = document.querySelector('.dragging');
            if(z.id.includes(cat)) { z.appendChild(d); sessionLog.dragCorrect++; }
            else { logError("Drag", d.textContent); }
            d.classList.remove('dragging');
        });
    });

    // Flashcards
    let cIdx = 0;
    function loadCard() {
        const d = flashcards[cIdx];
        document.getElementById('fc-front').innerText = d.f;
        document.getElementById('fc-back').innerHTML = `${d.b} <span class="tts-icon" onclick="event.stopPropagation(); speak('${d.b.replace(/<[^>]*>/g, '')}')">üîä</span>`;
        document.getElementById('flashcard').classList.remove('is-flipped');
    }
    window.flipCard = () => document.getElementById('flashcard').classList.toggle('is-flipped');
    window.nextCard = () => { cIdx=(cIdx+1)%flashcards.length; loadCard(); };
    window.prevCard = () => { cIdx=(cIdx-1+flashcards.length)%flashcards.length; loadCard(); };
    
    // REPORT GENERATOR (ENCRYPTION TRICK)
    window.generateReportCode = () => {
        const data = JSON.stringify(sessionLog);
        // Simple Base64 encoding to obfuscate (hide) the data
        const code = btoa(data); 
        document.getElementById('report-display').style.display = 'block';
        document.getElementById('report-code').innerText = code;
    };

    // Utils
    window.speak = (t) => {
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'es-ES';
        window.speechSynthesis.speak(u);
    };
    window.toggleTheme = () => document.body.classList.toggle('dark-mode');

    // Init
    generateQuiz(); generateStory(); generateDrag(); loadCard();
});
</script>
</body>
</html>
